{% extends "base.html" %}

{% block title %}Your Journey - Jack Van Zeeland{% endblock %}

{% block content %}

<!-- Journey Hero Section -->
<div class="journey-hero scroll-fade-up">
    <div class="container">
        <h1 class="journey-title">Your Portfolio Journey</h1>
        <p class="journey-subtitle">Track your exploration progress and unlock achievements</p>

        <!-- Overall Progress -->
        <div class="journey-progress-container">
            <div class="journey-progress-bar" id="journey-main-progress">
                <div class="journey-progress-fill" id="journey-progress-fill"></div>
            </div>
            <div class="journey-progress-text" id="journey-progress-text">0%</div>
        </div>
    </div>
</div>

<div class="container my-5">

    <!-- Journey Statistics -->
    <div class="row mb-5 scroll-fade-up">
        <div class="col-md-4 mb-3">
            <div class="journey-stat-card">
                <div class="journey-stat-icon">üìÑ</div>
                <div class="journey-stat-value" id="pages-visited-stat">0/13</div>
                <div class="journey-stat-label">Pages Visited</div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="journey-stat-card">
                <div class="journey-stat-icon">üèÜ</div>
                <div class="journey-stat-value" id="achievements-unlocked-stat">0/8</div>
                <div class="journey-stat-label">Achievements Unlocked</div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="journey-stat-card">
                <div class="journey-stat-icon">‚ú®</div>
                <div class="journey-stat-value" id="completion-stat">0%</div>
                <div class="journey-stat-label">Portfolio Explored</div>
            </div>
        </div>
    </div>

    <!-- Visited Pages Section -->
    <div class="scroll-fade-up">
        <h2 class="mb-4">Portfolio Pages</h2>
        <div class="visited-pages-grid" id="visited-pages-grid">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>

    <!-- Achievements Section -->
    <div class="scroll-fade-up mt-5">
        <h2 class="mb-4">Achievements</h2>
        <div id="achievements-widget" class="achievements-widget">
            <p class="text-muted">Explore the portfolio to unlock achievements!</p>
            <div id="achievements-grid" class="achievements-grid">
                <!-- Achievements will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Reset Journey Button -->
    <div class="text-center mt-5 scroll-fade-up">
        <button id="reset-journey-page-btn" class="btn btn-outline-danger">
            <i class="fas fa-redo"></i> Reset Journey
        </button>
    </div>

</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {

    // Use server data (injected by base.html)
    const JOURNEY_DATA = window.JOURNEY_DATA || {
        visitedPages: [],
        totalPages: 13,
        allPages: []
    };

    const visitedPages = JOURNEY_DATA.visitedPages;
    const TOTAL_PAGES = JOURNEY_DATA.totalPages;
    const ALL_PAGES = JOURNEY_DATA.allPages;

    console.log('Journey Page: Loaded', {
        visitedCount: visitedPages.length,
        totalPages: TOTAL_PAGES,
        allPagesCount: ALL_PAGES.length
    });

    // Calculate progress (exclude /journey from count)
    const contentPagesVisited = visitedPages.filter(path => path !== '/journey');
    const progress = Math.min(Math.round((contentPagesVisited.length / TOTAL_PAGES) * 100), 100);
    const unlockedAchievements = window.AchievementSystem ? AchievementSystem.getUnlockedAchievements().length : 0;

    // Update stats
    document.getElementById('journey-progress-fill').style.width = progress + '%';
    document.getElementById('journey-progress-text').textContent = progress + '%';
    document.getElementById('pages-visited-stat').textContent = contentPagesVisited.length + '/' + TOTAL_PAGES;
    document.getElementById('achievements-unlocked-stat').textContent = unlockedAchievements + '/8';
    document.getElementById('completion-stat').textContent = progress + '%';

    // Render visited pages grid
    const pagesGrid = document.getElementById('visited-pages-grid');
    ALL_PAGES.forEach(page => {
        const isVisited = visitedPages.includes(page.path);

        const pageItem = document.createElement('div');
        pageItem.className = `page-item ${isVisited ? 'visited' : 'unvisited'}`;

        pageItem.innerHTML = `
            <div class="page-item-icon">${page.icon}</div>
            <div class="page-item-name">${page.name}</div>
            ${isVisited ? '<div class="page-item-check">‚úì</div>' : ''}
        `;

        // Make visited pages clickable
        if (isVisited) {
            pageItem.style.cursor = 'pointer';
            pageItem.addEventListener('click', () => {
                window.location.href = page.path;
            });
        }

        pagesGrid.appendChild(pageItem);
    });

    // Populate achievements (unchanged)
    const achievementsGrid = document.getElementById('achievements-grid');
    if (achievementsGrid && window.AchievementSystem) {
        function renderAchievements() {
            const progress = AchievementSystem.getProgress();
            achievementsGrid.innerHTML = '';

            progress.forEach(achievement => {
                const item = document.createElement('div');
                item.className = `achievement-item ${achievement.unlocked ? 'unlocked' : 'locked'}`;
                item.setAttribute('role', 'listitem');
                item.setAttribute('aria-label', `${achievement.title} - ${achievement.unlocked ? 'Unlocked' : 'Locked'}`);

                item.innerHTML = `
                    <span class="achievement-item-icon">${achievement.icon}</span>
                    <div class="achievement-item-title">${achievement.title}</div>
                    <div class="achievement-item-desc">${achievement.description}</div>
                    ${!achievement.unlocked ? `
                        <div class="achievement-progress">
                            <div class="achievement-progress-bar" style="width: ${achievement.progress}%"></div>
                        </div>
                    ` : '<span class="achievement-badge">‚úì</span>'}
                `;

                achievementsGrid.appendChild(item);
            });
        }

        renderAchievements();
        document.addEventListener('achievement-unlocked', renderAchievements);
    }

    // Reset journey button
    document.getElementById('reset-journey-page-btn').addEventListener('click', function() {
        if (confirm('Are you sure you want to reset your journey? This will clear all visited pages and achievements.')) {
            // Clear localStorage
            StorageHelper.remove('visitedPages');
            StorageHelper.remove('portfolio_achievements');
            StorageHelper.remove('achievement_stats');

            // Clear server session via POST request
            fetch('/api/journey/reset', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            }).then(() => {
                window.location.reload();
            }).catch((error) => {
                console.error('Failed to reset server session:', error);
                // Reload anyway (localStorage is cleared)
                window.location.reload();
            });
        }
    });
});
</script>
{% endblock %}

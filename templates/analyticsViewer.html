{% extends "base.html" %}

{% block title %}Analytics Dashboard - Jack Van Zeeland{% endblock %}

{% block extra_head %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}

<!-- Dashboard Header -->
<div class="analytics-header scroll-fade-up">
    <div class="container">
        <h1 class="analytics-title">Analytics Dashboard</h1>
        <p class="analytics-subtitle">Portfolio visitor insights and engagement metrics</p>

        <!-- Time Range Selector -->
        <div class="time-range-selector">
            <button class="time-btn active" data-days="7">Last 7 Days</button>
            <button class="time-btn" data-days="30">Last 30 Days</button>
            <button class="time-btn" data-days="90">Last 90 Days</button>
            <button class="time-btn" data-days="365">All Time</button>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="analytics-loading" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
    <div style="text-align: center; color: white;">
        <div class="spinner spinner-lg"></div>
        <p style="margin-top: 1rem;">Loading analytics data...</p>
    </div>
</div>

<div class="container my-5">

    <!-- Summary Cards -->
    <div class="row mb-4 scroll-fade-up">
        <div class="col-md-3 mb-3">
            <div class="analytics-card">
                <div class="card-icon">üìä</div>
                <div class="card-value" id="total-events">0</div>
                <div class="card-label">Total Events</div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="analytics-card">
                <div class="card-icon">üë•</div>
                <div class="card-value" id="unique-sessions">0</div>
                <div class="card-label">Unique Sessions</div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="analytics-card">
                <div class="card-icon">üëÅÔ∏è</div>
                <div class="card-value" id="page-views">0</div>
                <div class="card-label">Page Views</div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="analytics-card">
                <div class="card-icon">‚è±Ô∏è</div>
                <div class="card-value" id="avg-time">0s</div>
                <div class="card-label">Avg Time on Page</div>
            </div>
        </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="row mb-4">
        <!-- Daily Page Views Chart -->
        <div class="col-md-6 mb-4 scroll-fade-up">
            <div class="chart-container">
                <h3 class="chart-title">Daily Page Views</h3>
                <canvas id="dailyViewsChart"></canvas>
            </div>
        </div>

        <!-- Popular Pages Chart -->
        <div class="col-md-6 mb-4 scroll-fade-up">
            <div class="chart-container">
                <h3 class="chart-title">Most Popular Pages</h3>
                <canvas id="popularPagesChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="row mb-4">
        <!-- Popular Projects Chart -->
        <div class="col-md-6 mb-4 scroll-fade-up">
            <div class="chart-container">
                <h3 class="chart-title">Most Viewed Projects</h3>
                <canvas id="popularProjectsChart"></canvas>
            </div>
        </div>

        <!-- Filter Usage Chart -->
        <div class="col-md-6 mb-4 scroll-fade-up">
            <div class="chart-container">
                <h3 class="chart-title">Filter Usage</h3>
                <canvas id="filterUsageChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Charts Row 3 -->
    <div class="row mb-4">
        <!-- Theme Switches -->
        <div class="col-md-6 mb-4 scroll-fade-up">
            <div class="chart-container">
                <h3 class="chart-title">Theme Preferences</h3>
                <canvas id="themeSwitchesChart"></canvas>
            </div>
        </div>

        <!-- Achievements Unlocked -->
        <div class="col-md-6 mb-4 scroll-fade-up">
            <div class="chart-container">
                <h3 class="chart-title">Achievement Unlocks</h3>
                <canvas id="achievementsChart"></canvas>
            </div>
        </div>
    </div>

</div>

{% endblock %}

{% block scripts %}
<script>
// Analytics Dashboard Script
let currentDays = 7;
let charts = {};

// Fetch and display analytics data
async function loadAnalytics(days = 7) {
    const loadingOverlay = document.getElementById('analytics-loading');

    try {
        // Show loading overlay
        if (loadingOverlay) {
            loadingOverlay.style.display = 'flex';
        }

        const response = await fetch(`/api/analytics/summary?days=${days}`);
        const data = await response.json();

        updateSummaryCards(data);
        updateCharts(data);
    } catch (error) {
        console.error('Failed to load analytics:', error);
        // Show error message to user
        alert('Failed to load analytics data. Please try again.');
    } finally {
        // Hide loading overlay
        if (loadingOverlay) {
            loadingOverlay.style.display = 'none';
        }
    }
}

// Update summary cards
function updateSummaryCards(data) {
    document.getElementById('total-events').textContent = data.total_events.toLocaleString();
    document.getElementById('unique-sessions').textContent = data.unique_sessions.toLocaleString();
    document.getElementById('page-views').textContent = data.page_views.toLocaleString();
    document.getElementById('avg-time').textContent = Math.round(data.avg_time_spent) + 's';
}

// Update all charts
function updateCharts(data) {
    updateDailyViewsChart(data.daily_breakdown);
    updatePopularPagesChart(data.popular_pages);
    updatePopularProjectsChart(data.popular_projects);
    updateFilterUsageChart(data.filter_usage);
    updateThemeSwitchesChart(data.theme_switches);
    updateAchievementsChart(data.achievements_unlocked);
}

// Daily Page Views Chart
function updateDailyViewsChart(dailyData) {
    const ctx = document.getElementById('dailyViewsChart').getContext('2d');

    if (charts.dailyViews) {
        charts.dailyViews.destroy();
    }

    charts.dailyViews = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dailyData.map(d => d.date),
            datasets: [{
                label: 'Page Views',
                data: dailyData.map(d => d.page_views),
                borderColor: 'rgb(79, 172, 254)',
                backgroundColor: 'rgba(79, 172, 254, 0.1)',
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

// Popular Pages Chart
function updatePopularPagesChart(popularPages) {
    const ctx = document.getElementById('popularPagesChart').getContext('2d');

    if (charts.popularPages) {
        charts.popularPages.destroy();
    }

    charts.popularPages = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: popularPages.map(p => p[0]),
            datasets: [{
                label: 'Views',
                data: popularPages.map(p => p[1]),
                backgroundColor: 'rgba(79, 172, 254, 0.7)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            indexAxis: 'y',
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: { beginAtZero: true }
            }
        }
    });
}

// Popular Projects Chart
function updatePopularProjectsChart(popularProjects) {
    const ctx = document.getElementById('popularProjectsChart').getContext('2d');

    if (charts.popularProjects) {
        charts.popularProjects.destroy();
    }

    charts.popularProjects = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: popularProjects.map(p => p[0]),
            datasets: [{
                label: 'Interactions',
                data: popularProjects.map(p => p[1]),
                backgroundColor: 'rgba(0, 242, 254, 0.7)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            indexAxis: 'y',
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: { beginAtZero: true }
            }
        }
    });
}

// Filter Usage Chart
function updateFilterUsageChart(filterUsage) {
    const ctx = document.getElementById('filterUsageChart').getContext('2d');

    if (charts.filterUsage) {
        charts.filterUsage.destroy();
    }

    charts.filterUsage = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: filterUsage.map(f => f[0]),
            datasets: [{
                data: filterUsage.map(f => f[1]),
                backgroundColor: [
                    'rgba(79, 172, 254, 0.7)',
                    'rgba(0, 242, 254, 0.7)',
                    'rgba(136, 84, 208, 0.7)',
                    'rgba(239, 68, 68, 0.7)',
                    'rgba(34, 197, 94, 0.7)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true
        }
    });
}

// Theme Switches Chart
function updateThemeSwitchesChart(themeSwitches) {
    const ctx = document.getElementById('themeSwitchesChart').getContext('2d');

    if (charts.themeSwitches) {
        charts.themeSwitches.destroy();
    }

    charts.themeSwitches = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Light Mode', 'Dark Mode'],
            datasets: [{
                data: [themeSwitches.light, themeSwitches.dark],
                backgroundColor: [
                    'rgba(255, 206, 86, 0.7)',
                    'rgba(54, 162, 235, 0.7)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true
        }
    });
}

// Achievements Chart
function updateAchievementsChart(achievements) {
    const ctx = document.getElementById('achievementsChart').getContext('2d');

    if (charts.achievements) {
        charts.achievements.destroy();
    }

    charts.achievements = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: achievements.map(a => a[0]),
            datasets: [{
                label: 'Unlocks',
                data: achievements.map(a => a[1]),
                backgroundColor: 'rgba(136, 84, 208, 0.7)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            indexAxis: 'y',
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: { beginAtZero: true }
            }
        }
    });
}

// Time range selector
document.querySelectorAll('.time-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        // Update active state
        document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');

        // Load new data
        currentDays = parseInt(this.dataset.days);
        loadAnalytics(currentDays);
    });
});

// Initial load
document.addEventListener('DOMContentLoaded', () => {
    loadAnalytics(currentDays);
});
</script>
{% endblock %}
